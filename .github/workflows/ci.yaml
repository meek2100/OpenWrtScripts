name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  # Run once a month on the 1st at 00:00 UTC
  schedule:
    - cron: "0 0 1 * *"

jobs:
  test:
    name: Lint, Test, and Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellSpec
        run: curl -fsSL https://git.io/shellspec | sh -s -- -y

      - name: Install Kcov (Code Coverage)
        run: |
          sudo apt-get update
          sudo apt-get install -y kcov

      - name: Run ShellSpec with Coverage
        # This runs all specs and generates a coverage report
        run: |
          # Add shellspec to path
          export PATH=$PATH:$HOME/.local/lib/shellspec/bin

          # Run specs with kcov enabled
          shellspec --kcov
        continue-on-error: false

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      # Keep your existing pre-commit hooks
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install pre-commit
          # go install mvdan.cc/sh/v3/cmd/shfmt@latest # Optional if pre-commit installs it

      - name: Run pre-commit
        run: pre-commit run --all-files --show-diff-on-failure
