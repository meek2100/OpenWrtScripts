name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 0 1 * *"

jobs:
  lint:
    name: Lint (Pre-commit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files --show-diff-on-failure

  test:
    name: Test and Coverage
    runs-on: ubuntu-latest
    needs: lint
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellSpec
        run: |
          curl -fsSL https://git.io/shellspec | sh -s -- -y
          # Initialize shellspec to create .shellspec configuration
          $HOME/.local/lib/shellspec/bin/shellspec --init

      - name: Install Test dependencies
        run: |
          # Install dependencies required to build kcov and run tests
          sudo apt-get update
          sudo apt-get install -y binutils-dev libcurl4-openssl-dev zlib1g-dev libdw-dev libiberty-dev cmake build-essential python3 netperf snmp

          # Clone and build kcov
          git clone https://github.com/SimonKagstrom/kcov.git
          cd kcov
          mkdir build && cd build
          cmake ..
          make
          sudo make install

      - name: Run ShellSpec with Coverage
        # Ensure the path includes shellspec
        run: |
          export PATH=$PATH:$HOME/.local/lib/shellspec/bin
          chmod +x *.sh
          shellspec --kcov
        continue-on-error: false

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
